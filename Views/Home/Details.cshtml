@model NemeShop.Models.SanPham
@{
    var reviews = ViewBag.Reviews as List<NemeShop.Models.DanhGiaSanPhamDto>;
    ViewData["Title"] = "Chi tiết sản phẩm";
}

<div class="container mt-4">
    <!-- Thông tin sản phẩm -->
    <div class="row">
        <div class="col-md-6">
            <img src="@(string.IsNullOrEmpty(Model.HinhAnh) ? "/images/placeholder.png" : Model.HinhAnh)"
                 class="img-fluid rounded shadow-sm" alt="@Model.TenSp" />
        </div>
        <div class="col-md-6">
            <h2>@Model.TenSp</h2>
            <p class="text-muted">Danh mục: @Model.MaLoaiNavigation?.TenLoai</p>
            <h4 class="text-danger">@String.Format("{0:N0} ₫", Model.DonGia)</h4>
            <p><strong>Tồn kho:</strong> @(Model.SoLuong > 0 ? $"{Model.SoLuong} sản phẩm" : "Hết hàng")</p>
            <p><strong>Mô tả:</strong> @Model.MoTa</p>

            <div class="d-flex gap-2 flex-wrap">
                <!-- Form Mua ngay -->
                <form id="buyNowForm" class="flex-grow-1">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="maSp" value="@Model.MaSp" />
                    <input type="hidden" id="buyQty" name="soLuong" value="1" />
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        Mua ngay
                    </button>
                </form>

                <!-- Nút yêu thích -->
                <button id="btnWishlist" data-id="@Model.MaSp" class="btn btn-outline-danger btn-lg">
                    <i class="bi bi-heart-fill me-2"></i>Yêu thích
                </button>
            </div>
        </div>
    </div>

    <hr />

    <!-- Đánh giá -->
    <div class="mt-4">
        <h4>Đánh giá của khách hàng</h4>
        <div id="review-container">
            @await Html.PartialAsync("_ReviewListPartial", reviews)
        </div>

        <button class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#reviewModal">
            Viết đánh giá
        </button>
    </div>
</div>

<!-- Modal đánh giá -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form id="review-form" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="MaSp" value="@Model.MaSp" />
                <input type="hidden" name="MaKh" value="1003" /> <!-- giả định khách hàng login -->

                <div class="modal-header">
                    <h5 class="modal-title">Đánh giá sản phẩm: @Model.TenSp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label>Số sao</label>
                        <select name="SoSao" class="form-select">
                            <option value="5">5 sao</option>
                            <option value="4">4 sao</option>
                            <option value="3">3 sao</option>
                            <option value="2">2 sao</option>
                            <option value="1">1 sao</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label>Nội dung</label>
                        <textarea name="NoiDung" class="form-control"></textarea>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" value="true" name="LaYeuThich" class="form-check-input" />
                        <label class="form-check-label">Đánh dấu yêu thích</label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">Gửi đánh giá</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {

            // Thiết lập global: gửi cookie cho Ajax jQuery (thường jQuery gửi cookie theo domain; xhrFields withCredentials an toàn)
            $.ajaxSetup({
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').first().val()
                },
                xhrFields: { withCredentials: true }
            });

            // Mua ngay (Ajax + confirm bằng SweetAlert2)
            $("#buyNowForm").on("submit", function (e) {
                e.preventDefault();
                var form = $(this);
                var formData = form.serialize();

                Swal.fire({
                    title: 'Xác nhận mua hàng',
                    text: 'Bạn có chắc muốn mua ngay sản phẩm này không?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33'
                }).then(function (result) {
                    if (!result.isConfirmed) return;

                    $.ajax({
                        url: '/HoaDon/MuaNgay',
                        type: 'POST',
                        data: formData,
                        headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').first().val() },
                        xhrFields: { withCredentials: true },
                        success: function (res) {
                            if (res.success) {
                                Swal.fire({
                                    title: 'Đặt hàng thành công',
                                    text: res.message,
                                    icon: 'success',
                                    confirmButtonText: 'Xem đơn hàng'
                                }).then(function () {
                                    window.location.href = res.redirectUrl;
                                });
                            } else {
                                Swal.fire('Thông báo', res.message, 'warning');
                                if (res.message && res.message.toLowerCase().includes('đăng nhập')) {
                                    // Nếu server trả cần login, mở trang login
                                    window.location.href = '/Account/Login';
                                }
                            }
                        },
                        error: function (xhr) {
                            Swal.fire('Lỗi', 'Có lỗi xảy ra: ' + (xhr.statusText || xhr.status), 'error');
                        }
                    });
                });
            });

            // Review submit (Ajax)
            $("#review-form").on("submit", function (e) {
                e.preventDefault();
                var form = $(this);
                $.ajax({
                    url: '@Url.Action("AddReview", "Home")',
                    type: 'POST',
                    data: form.serialize(),
                    headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').first().val() },
                    xhrFields: { withCredentials: true },
                    success: function (html) {
                        $("#review-container").html(html);
                        $("#reviewModal").modal('hide');
                        form[0].reset();
                    },
                    error: function (xhr) {
                        Swal.fire('Lỗi', 'Gửi đánh giá thất bại.', 'error');
                    }
                });
            });

            // Wishlist (demo)
            $("#btnWishlist").click(function () {
                var id = $(this).data('id');
                Swal.fire('Yêu thích', 'Đã thêm sản phẩm #' + id + ' vào yêu thích (demo).', 'success');
                // Gọi Ajax vào backend nếu cần
            });

        });
    </script>
}
